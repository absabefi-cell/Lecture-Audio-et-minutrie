<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lecteur audio + Minuterie + Graphes</title>

  <style>
    body {
      margin: 16px;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: #00000;
      color: #cfeeff; /* texte bleu clair */
    }
    h1 {
      font-size: 1.3rem;
      margin-bottom: 10px;
      color: #0035A0;
    }
    .panel {
      border: 1px solid #ffeb3b;
      border-radius: 10px;
      padding: 10px;
      margin-bottom: 14px;
      background: #001327;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    button {
      padding: 6px 10px;
      border-radius: 6px;
      border: 1px solid #00e5ff;
      background: #003b5c;
      color: #ffeb3b;
      font-weight: 600;
    }
    button:disabled {
      opacity: 0.6;
    }
    #stats {
      font-size: 0.95rem;
      color: #9cff57;
    }
    #listeAudios {
      max-height: 240px;
      overflow-y: auto;
      background: #000d1f;
      padding: 6px;
      border-radius: 6px;
      border: 1px solid #224466;
      font-size: 0.9rem;
    }
    .audio-item {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 2px 0;
    }
    .audio-name {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      color: #fffa99;
    }
    .audio-name.current {
      font-weight: 700;
      color: #00e5ff;
    }
    #progressCanvas, #freqCanvas {
      width: 100%;
      background: #00000;
      border-radius: 6px;
      border: 1px solid #224466;
      display: block;
      margin-top: 6px;
    }
    #progressCanvas { height: 40px; }
    #freqCanvas { height: 120px; }
    #timeInfo {
      font-size: 0.9rem;
      margin-top: 4px;
      color: #80ffea;
    }
    #timerDisplay { color: #9cff57; }
    .timer-input {
      width: 60px;
      padding: 3px;
      border-radius: 4px;
      border: 1px solid #ffeb3b;
      background: #000d1f;
      color: #cfeeff;
      text-align: center;
    }
    #currentTrack {
      color: #ffeb3b;
      font-weight: 600;
    }

    /* HORLOGE EN HAUT À GAUCHE */
    #clock {
      position: fixed;
      top: 1px;
      right: 2px;
      font-size: 1rem;
      font-weight: bold;
      color: #00e5ff; /* bleu fluo */
      background: #001327;
      padding: 2px 6px;
      border-radius: 6px;
      border: 1px solid #ffeb3b; /* contour jaune */
    }
  </style>
</head>

<body>

  <!-- HORLOGE FIXE -->
  <div id="clock"></div>

  <h1>Lecteur audio avec sélection multiples + Minuterie + Graphique</h1>

  <!-- PANEL 1 -->
  <div class="panel">
    <div class="row">
      <input id="fileInput" type="file" accept="audio/*" multiple />
      <button id="clearBtn" type="button">Vider la liste</button>
    </div>
    <div id="stats">
      Audios choisis : <span id="count">0</span><br>
      Audios sélectionnés : <span id="countSelected">0</span><br>
      Durée totale sélectionnée : <span id="totalDuration">0:00:00</span>
    </div>
  </div>

  <!-- PANEL 2 -->
  <div class="panel">
    <div class="row">
      <button id="selectAllBtn" type="button">Tout cocher</button>
      <button id="unselectAllBtn" type="button">Tout décocher</button>
      <button id="calcDurationBtn" type="button">Calculer durée sélectionnée</button>

      <!-- Volume aligné -->
      <div style="display:flex; align-items:center; gap:8px;">
        <label for="vol">Volume</label>
        <input id="vol" type="range" min="0" max="1" step="0.001" value="0.9">
        <span id="volVal" class="pill">0.90</span>
      </div>
    </div>
    <div id="progress"></div>
    <div id="listeAudios"></div>
  </div>

  <!-- PANEL 3 -->
  <div class="panel">
    <div class="row">
      <button id="prevBtn" type="button">⏮ Précédent</button>
      <button id="playPauseBtn" type="button">▶ Lecture</button>
      <button id="nextBtn" type="button">⏭ Suivant</button>
    </div>
    <div>Piste actuelle : <span id="currentTrack">aucune</span></div>
    <audio id="player"></audio>
    <canvas id="progressCanvas"></canvas>
    <canvas id="freqCanvas"></canvas>
    <div id="timeInfo"></div>
  </div>

  <!-- PANEL 4 -->
  <div class="panel">
    <div class="row">
      <span>Minuterie (arrêt lecture) :</span>
    </div>
    <div class="row">
      <label>Min :</label>
      <input id="timerMin" class="timer-input" type="number" min="0" value="0" />
      <label>Sec :</label>
      <input id="timerSec" class="timer-input" type="number" min="0" max="59" value="0" />
      <button id="startTimerBtn" type="button">Démarrer</button>
      <button id="stopTimerBtn" type="button">Arrêter</button>
    </div>
    <div id="timerDisplay">Minuterie arrêtée.</div>
  </div>

  <!-- SCRIPT -->
  <script>
    const vol = document.getElementById('vol');
    const volVal = document.getElementById('volVal');

    const fileInput = document.getElementById('fileInput');
    const clearBtn = document.getElementById('clearBtn');
    const countSpan = document.getElementById('count');
    const countSelectedSpan = document.getElementById('countSelected');
    const totalDurationSpan = document.getElementById('totalDuration');
    const listeAudiosDiv = document.getElementById('listeAudios');
    const selectAllBtn = document.getElementById('selectAllBtn');
    const unselectAllBtn = document.getElementById('unselectAllBtn');
    const calcDurationBtn = document.getElementById('calcDurationBtn');
    const progressDiv = document.getElementById('progress');

    const player = document.getElementById('player');
    const progressCanvas = document.getElementById('progressCanvas');
    const freqCanvas = document.getElementById('freqCanvas');
    const timeInfo = document.getElementById('timeInfo');
    const currentTrackSpan = document.getElementById('currentTrack');
    const prevBtn = document.getElementById('prevBtn');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const nextBtn = document.getElementById('nextBtn');

    const timerMinInput = document.getElementById('timerMin');
    const timerSecInput = document.getElementById('timerSec');
    const startTimerBtn = document.getElementById('startTimerBtn');
    const stopTimerBtn = document.getElementById('stopTimerBtn');
    const timerDisplay = document.getElementById('timerDisplay');

    let allFiles = [];
    let objectURLs = new Map();
    let currentIndex = -1;

    const ctxProg = progressCanvas.getContext('2d');
    const ctxFreq = freqCanvas.getContext('2d');
    let audioCtx = null;
    let analyser = null;
    let freqData = null;
    let freqAnimId = null;
    let gainNode = null;

    let timerInterval = null;
    let timerRemaining = 0;

    /* HORLOGE */
    function updateClock() {
      const now = new Date();
      let h = now.getHours().toString().padStart(2, "0");
      let m = now.getMinutes().toString().padStart(2, "0");
      let s = now.getSeconds().toString().padStart(2, "0");
      document.getElementById("clock").textContent = `${h}:${m}:${s}`;
    }
    setInterval(updateClock, 1000);
    updateClock();

    /* VOLUME */
    vol.addEventListener('input', () => {
      const v = parseFloat(vol.value);
      volVal.textContent = v.toFixed(2);
      if (gainNode) gainNode.gain.value = v;
    });

    /* ---------- GESTION FICHIERS ---------- */
    fileInput.addEventListener('change', () => {
      const files = Array.from(fileInput.files || []);
      allFiles = files.filter(f => f.type.startsWith('audio/'));
      renderList();
      updateStats();
      progressDiv.textContent = '';
      totalDurationSpan.textContent = '0:00:00';
      if (allFiles.length > 0) {
        currentIndex = 0;
        loadFile(currentIndex, false);
      }
    });

    clearBtn.addEventListener('click', () => {
      allFiles = [];
      fileInput.value = '';
      listeAudiosDiv.innerHTML = '';
      updateStats();
      totalDurationSpan.textContent = '0:00:00';
      progressDiv.textContent = '';
      stopPlayerAndClean();
      currentIndex = -1;
      currentTrackSpan.textContent = 'aucune';
      clearProgressCanvas();
      clearFreqCanvas();
      timeInfo.textContent = '';
    });

    function renderList() {
      listeAudiosDiv.innerHTML = '';
      allFiles.forEach((file, index) => {
        const item = document.createElement('div');
        item.className = 'audio-item';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.dataset.index = index;
        checkbox.addEventListener('change', updateStats);

        const label = document.createElement('span');
        label.className = 'audio-name';
        label.textContent = file.name;
        label.dataset.index = index;

        label.addEventListener('click', () => {
          playIndex(index);
        });

        item.appendChild(checkbox);
        item.appendChild(label);
        listeAudiosDiv.appendChild(item);
      });

      updateCurrentHighlight();
    }

    function updateStats() {
      countSpan.textContent = allFiles.length.toString();
      const checkboxes = listeAudiosDiv.querySelectorAll('input[type="checkbox"]');
      let selected = 0;
      checkboxes.forEach(cb => { if (cb.checked) selected++; });
      countSelectedSpan.textContent = selected.toString();
    }

    /* CHARGEMENT ET LECTURE AUDIO */
    function stopPlayerAndClean() {
      player.pause();
      player.removeAttribute('src');
      player.load();
      for (const url of objectURLs.values()) {
        URL.revokeObjectURL(url);
      }
      objectURLs.clear();
      playPauseBtn.textContent = '▶ Lecture';
    }

    function loadFile(index, autoplay) {
      const file = allFiles[index];
      if (!file) return;
      stopPlayerAndClean();
      const url = URL.createObjectURL(file);
      objectURLs.set(index, url);
      player.src = url;
      currentIndex = index;
      currentTrackSpan.textContent = file.name;
      updateCurrentHighlight();
      drawProgress();
      updateTimeInfo();
      if (autoplay) startPlayback();
    }

    function playIndex(index) {
      if (index < 0 || index >= allFiles.length) return;
      loadFile(index, true);
    }

    function updateCurrentHighlight() {
      const labels = listeAudiosDiv.querySelectorAll('.audio-name');
      labels.forEach(lab => {
        const idx = parseInt(lab.dataset.index, 10);
        if (idx === currentIndex) lab.classList.add('current');
        else lab.classList.remove('current');
      });
    }

    selectAllBtn.addEventListener('click', () => {
      document.querySelectorAll('#listeAudios input[type="checkbox"]').forEach(cb => cb.checked = true);
      updateStats();
    });

    unselectAllBtn.addEventListener('click', () => {
      document.querySelectorAll('#listeAudios input[type="checkbox"]').forEach(cb => cb.checked = false);
      updateStats();
    });

    /* ---------- DUREE ---------- */
    calcDurationBtn.addEventListener('click', async () => {
      const checkboxes = Array.from(listeAudiosDiv.querySelectorAll('input[type="checkbox"]'));
      const selectedIndexes = checkboxes.filter(cb => cb.checked)
        .map(cb => parseInt(cb.dataset.index, 10))
        .filter(i => !Number.isNaN(i));

      if (selectedIndexes.length === 0) {
        progressDiv.textContent = 'Aucun audio sélectionné.';
        return;
      }

      progressDiv.textContent = 'Calcul en cours...';
      calcDurationBtn.disabled = true;

      let totalSeconds = 0;
      const tempAudio = document.createElement('audio');

      for (let i = 0; i < selectedIndexes.length; i++) {
        const idx = selectedIndexes[i];
        const file = allFiles[idx];
        if (!file) continue;

        progressDiv.textContent = `Calcul ${i + 1} / ${selectedIndexes.length} : ${file.name}`;

        const url = URL.createObjectURL(file);
        try {
          const duration = await getDurationFromAudioElement(tempAudio, url);
          totalSeconds += duration || 0;
        } finally {
          URL.revokeObjectURL(url);
        }
        await new Promise(r => setTimeout(r, 10));
      }

      const h = Math.floor(totalSeconds / 3600);
      const m = Math.floor((totalSeconds % 3600) / 60);
      const s = Math.floor(totalSeconds % 60);
      totalDurationSpan.textContent = `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;

      progressDiv.textContent = 'Calcul terminé.';
      calcDurationBtn.disabled = false;
    });

    function getDurationFromAudioElement(audioElem, url) {
      return new Promise((resolve) => {
        const onLoaded = () => { cleanup(); resolve(isFinite(audioElem.duration) ? audioElem.duration : 0); };
        const onError = () => { cleanup(); resolve(0); };
        function cleanup() {
          audioElem.removeEventListener('loadedmetadata', onLoaded);
          audioElem.removeEventListener('error', onError);
        }
        audioElem.addEventListener('loadedmetadata', onLoaded);
        audioElem.addEventListener('error', onError);
        audioElem.src = url;
        audioElem.load();
      });
    }

    /* ---------- CANVAS ---------- */
    function clearProgressCanvas() {
      const w = progressCanvas.width;
      const h = progressCanvas.height;
      ctxProg.fillStyle = '#000d1f';
      ctxProg.fillRect(0, 0, w, h);
    }

    function drawProgress() {
      const w = progressCanvas.width;
      const h = progressCanvas.height;
      ctxProg.fillStyle = '#000d1f';
      ctxProg.fillRect(0, 0, w, h);

      const duration = player.duration || 0;
      const current = player.currentTime || 0;
      const ratio = duration > 0 ? current / duration : 0;

      ctxProg.fillStyle = '#224466';
      ctxProg.fillRect(2, h / 3, w - 4, h / 3);

      ctxProg.fillStyle = '#ffeb3b';
      ctxProg.fillRect(2, h / 3, (w - 4) * ratio, h / 3);
    }

    function updateTimeInfo() {
      const cur = formatTime(player.currentTime || 0);
      const dur = formatTime(player.duration || 0);
      timeInfo.textContent = `${cur} / ${dur}`;
    }

    function formatTime(sec) {
      sec = Math.floor(sec);
      const h = Math.floor(sec / 3600);
      const m = Math.floor((sec % 3600) / 60);
      const s = sec % 60;
      return h > 0 ? `${h}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}` : `${m}:${String(s).padStart(2, '0')}`;
    }

    player.addEventListener('timeupdate', () => { drawProgress(); updateTimeInfo(); });
    player.addEventListener('loadedmetadata', () => { drawProgress(); updateTimeInfo(); });
    player.addEventListener('ended', () => { drawProgress(); updateTimeInfo(); goNext(); });

    /* ---------- FREQUENCES ---------- */
    function ensureAudioContext() {
      if (!audioCtx) {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        audioCtx = new AC();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        freqData = new Uint8Array(analyser.frequencyBinCount);

        const source = audioCtx.createMediaElementSource(player);

        gainNode = audioCtx.createGain();
        gainNode.gain.value = parseFloat(vol.value);

        source.connect(gainNode);
        gainNode.connect(analyser);
        analyser.connect(audioCtx.destination);
      }
      if (audioCtx.state === 'suspended') audioCtx.resume().catch(() => {});
      if (!freqAnimId) animateFreq();
    }

    function clearFreqCanvas() {
      const w = freqCanvas.width;
      const h = freqCanvas.height;
      ctxFreq.fillStyle = '#F2F2F2';
      ctxFreq.fillRect(0, 0, w, h);
    }

    function drawFreq() {
      clearFreqCanvas();
      if (!analyser || !freqData) return;

      analyser.getByteFrequencyData(freqData);
      const w = freqCanvas.width;
      const h = freqCanvas.height;

      const barCount = 40;
      const step = Math.max(1, Math.floor(freqData.length / barCount));
      const barWidth = (w - 4) / barCount;

      for (let i = 0; i < barCount; i++) {
        const v = freqData[i * step] || 0;
        const barHeight = (v / 255) * (h - 6);
        const x = 2 + i * barWidth;
        const y = h - 2 - barHeight;

        ctxFreq.fillStyle = '#224466';
        ctxFreq.fillRect(x, h - 4, barWidth - 1, 2);

        const g = ctxFreq.createLinearGradient(x, y, x, h);
        g.addColorStop(0, '#ffeb3b');
        g.addColorStop(0.5, '#9cff57');
        g.addColorStop(1, '#00e5ff');
        ctxFreq.fillStyle = g;
        ctxFreq.fillRect(x, y, barWidth - 1, barHeight);
      }
    }

    function animateFreq() {
      drawFreq();
      freqAnimId = requestAnimationFrame(animateFreq);
    }

    /* ---------- CONTROLES ---------- */
    function startPlayback() {
      ensureAudioContext();
      player.play().then(() => {
        playPauseBtn.textContent = '⏸ Pause';
      }).catch(() => {});
    }

    playPauseBtn.addEventListener('click', () => {
      if (!player.src) {
        if (allFiles.length > 0) playIndex(currentIndex >= 0 ? currentIndex : 0);
        return;
      }
      if (player.paused) startPlayback();
      else {
        player.pause();
        playPauseBtn.textContent = '▶ Lecture';
      }
    });

    prevBtn.addEventListener('click', () => { goPrev(); });
    nextBtn.addEventListener('click', () => { goNext(); });

    function goPrev() {
      if (allFiles.length === 0) return;
      let newIndex = currentIndex > 0 ? currentIndex - 1 : allFiles.length - 1;
      playIndex(newIndex);
    }

    function goNext() {
      if (allFiles.length === 0) return;
      let newIndex = currentIndex < allFiles.length - 1 ? currentIndex + 1 : 0;
      playIndex(newIndex);
    }

    /* ---------- MINUTERIE ---------- */
    startTimerBtn.addEventListener('click', () => {
      const min = parseInt(timerMinInput.value, 10) || 0;
      const sec = parseInt(timerSecInput.value, 10) || 0;
      const total = min * 60 + sec;
      if (total <= 0) {
        timerDisplay.textContent = 'Veuillez entrer une durée > 0.';
        return;
      }
      if (timerInterval) clearInterval(timerInterval);
      timerRemaining = total;
      updateTimerDisplay();
      timerInterval = setInterval(() => {
        timerRemaining--;
        if (timerRemaining <= 0) {
          clearInterval(timerInterval);
          timerInterval = null;
          timerRemaining = 0;
          updateTimerDisplay();
          player.pause();
          playPauseBtn.textContent = '▶ Lecture';
        } else updateTimerDisplay();
      }, 1000);
    });

    stopTimerBtn.addEventListener('click', () => {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = null;
      timerRemaining = 0;
      timerDisplay.textContent = 'Minuterie arrêtée.';
    });

    function updateTimerDisplay() {
      const m = Math.floor(timerRemaining / 60);
      const s = timerRemaining % 60;
      timerDisplay.textContent = `Temps restant : ${m}:${String(s).padStart(2, '0')}`;
    }

    /* ---------- INIT ---------- */
    window.addEventListener('resize', () => {
      progressCanvas.width = progressCanvas.clientWidth;
      progressCanvas.height = 40;
      freqCanvas.width = freqCanvas.clientWidth;
      freqCanvas.height = 120;
      drawProgress();
      drawFreq();
    });

    progressCanvas.width = progressCanvas.clientWidth;
    freqCanvas.width = freqCanvas.clientWidth;
    drawProgress();
    clearFreqCanvas();

  </script>

</body>
</html>